<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagn√≥stico Vehicular Toyota Corolla</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="container">
        <h1>Motor de Inferencia Toyota Corolla</h1>

        <!-- Navegaci√≥n por pesta√±as -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('chat')" id="chat-tab">
                <span class="tab-icon">üí¨</span>
                Chat Libre
            </button>
            <button class="tab-button" onclick="switchTab('form')" id="form-tab">
                <span class="tab-icon">üìã</span>
                Formulario Guiado
            </button>
        </div>

        <!-- Contenido del Chat -->
        <div class="tab-content active" id="chat-content">
            <p>Describe la falla del veh√≠culo con tus propias palabras:</p>
            <textarea id="input" placeholder="Ej: el motor hace un ruido extra√±o y huele a quemado..."></textarea>
            <br>
            <button onclick="diagnose()">Diagnosticar</button>
        </div>

        <!-- Contenido del Formulario Din√°mico -->
        <div class="tab-content" id="form-content">
            <!-- Historial de selecciones -->
            <div class="selection-history" id="selection-history">
                <h4>üìã Historial de Selecciones:</h4>
                <div class="history-items" id="history-items">
                    <span class="history-placeholder">Ninguna selecci√≥n realizada</span>
                </div>
            </div>

            <div class="form-step active" id="step-1">
                <h3>¬øQu√© sistema tiene problemas?</h3>
                <div class="button-grid">
                    <button class="category-btn" onclick="selectCategory('motor')">
                        <span class="btn-icon">üîß</span>
                        Motor
                    </button>
                    <button class="category-btn" onclick="selectCategory('frenos')">
                        <span class="btn-icon">üõë</span>
                        Frenos
                    </button>
                    <button class="category-btn" onclick="selectCategory('transmisi√≥n')">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        Transmisi√≥n
                    </button>
                    <button class="category-btn" onclick="selectCategory('suspensi√≥n')">
                        <span class="btn-icon">üöó</span>
                        Suspensi√≥n
                    </button>
                    <button class="category-btn" onclick="selectCategory('el√©ctrico')">
                        <span class="btn-icon">‚ö°</span>
                        Sistema El√©ctrico
                    </button>
                    <button class="category-btn" onclick="selectCategory('combustible')">
                        <span class="btn-icon">‚õΩ</span>
                        Combustible
                    </button>
                    <button class="category-btn" onclick="selectCategory('refrigeraci√≥n')">
                        <span class="btn-icon">üå°Ô∏è</span>
                        Refrigeraci√≥n
                    </button>
                    <button class="category-btn" onclick="selectCategory('direcci√≥n')">
                        <span class="btn-icon">üéØ</span>
                        Direcci√≥n
                    </button>
                    <button class="category-btn" onclick="selectCategory('neum√°ticos')">
                        <span class="btn-icon">üõû</span>
                        Neum√°ticos
                    </button>
                </div>
            </div>

            <div class="form-step" id="step-2">
                <h3>¬øQu√© problema espec√≠fico tienes?</h3>
                <div class="problem-buttons" id="problem-buttons">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
            </div>

            <div class="form-step" id="step-3">
                <h3>¬øHay s√≠ntomas adicionales?</h3>
                <div class="symptoms-buttons" id="symptoms-buttons">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div class="step-buttons">
                    <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
                    <button class="diagnose-btn" onclick="diagnoseFromForm()">Diagnosticar</button>
                </div>
            </div>
        </div>

        <div id="result"></div>
        <div id="feedback" class="feedback-buttons">
            <p>¬øFue √∫til este diagn√≥stico?</p>
            <button onclick="giveFeedback(true)">S√≠</button>
            <button onclick="giveFeedback(false)">No</button>
        </div>
    </div>

    <!-- Contenedor de notificaciones -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        let lastDiagnosis = null;
        let currentStep = 1;
        let selectedCategory = '';
        let selectedProblem = '';
        let selectedSymptoms = [];

        // Datos del formulario din√°mico - ACTUALIZADO
        const formData = {
            motor: {
                problems: {
                    'ruido extra√±o': ['escape', 'v√°lvulas', 'pistones', 'knock', 'martilleo'],
                    'no enciende': ['bater√≠a', 'motor de arranque', 'combustible', 'buj√≠as'],
                    'sobrecalentamiento': ['refrigerante', 'termostato', 'ventilador'],
                    'vibraci√≥n': ['soportes', 'rpm', 'balanceo'],
                    'p√©rdida de potencia': ['filtros', 'inyectores', 'compresi√≥n'],
                    'olor a quemado': ['sobrecalentamiento', 'problema el√©ctrico', 'fuga de aceite'],
                    'consume aceite': ['sellos', 'juntas', 'desgaste de pistones'],
                    'problema de escape': ['rotura', 'desgaste', 'sistema de escape']
                }
            },
            frenos: {
                problems: {
                    'pedal suave': ['l√≠quido', 'aire', 'fugas'],
                    'chirrido al frenar': ['pastillas', 'discos', 'desgaste'],
                    'vibraci√≥n al frenar': ['discos', 'alineaci√≥n', 'desbalance'],
                    'no frena bien': ['pastillas', 'l√≠quido', 'sistema hidr√°ulico'],
                    'luz de frenos': ['nivel de l√≠quido', 'pastillas', 'sensores'],
                    'frenado deficiente': ['pastillas', 'discos', 'l√≠quido de frenos']
                }
            },
            transmisi√≥n: {
                problems: {
                    'cambios dif√≠ciles': ['embrague', 'sincronizadores', 'l√≠quido'],
                    'patina': ['embrague', 'discos', 'desgaste'],
                    'ruidos en cambios': ['rodamientos', 'engranajes', 'sincronizadores'],
                    'p√©rdida de l√≠quido': ['sellos', 'juntas', 'fugas'],
                    'problema de embrague': ['disco', 'plato', 'cojinete'],
                    'transmisi√≥n autom√°tica': ['l√≠quido', 'sensores', 'v√°lvulas']
                }
            },
            suspensi√≥n: {
                problems: {
                    'golpes': ['amortiguadores', 'resortes', 'bujes'],
                    'rebota': ['amortiguadores', 'resortes', 'desgaste'],
                    'ruidos en suspensi√≥n': ['bujes', 'terminales', 'amortiguadores'],
                    'inestable': ['alineaci√≥n', 'balanceo', 'neum√°ticos'],
                    'problema de amortiguadores': ['desgaste', 'fugas', 'funcionamiento'],
                    'problema de resortes': ['rotura', 'desgaste', 'debilitamiento']
                }
            },
            el√©ctrico: {
                problems: {
                    'no arranca': ['bater√≠a', 'motor de arranque', 'cables'],
                    'luces d√©biles': ['bater√≠a', 'alternador', 'regulador'],
                    'problema de bater√≠a': ['carga', 'terminales', 'cables'],
                    'problema de alternador': ['fallo', 'regulador', 'sistema de carga'],
                    'cortocircuito': ['cables', 'conectores', 'componentes'],
                    'fusibles quemados': ['fusibles', 'sistema el√©ctrico']
                }
            },
            combustible: {
                problems: {
                    'no arranca': ['bomba', 'filtro', 'inyectores'],
                    'p√©rdida de potencia': ['filtro', 'bomba', 'presi√≥n'],
                    'consumo alto': ['inyectores', 'filtro', 'sensor'],
                    'olor a gasolina': ['fugas', 'l√≠neas', 'tanque'],
                    'problema de bomba': ['fallo', 'filtro', 'presi√≥n'],
                    'problema de inyectores': ['limpieza', 'funcionamiento', 'reemplazo']
                }
            },
            refrigeraci√≥n: {
                problems: {
                    'sobrecalentamiento': ['refrigerante', 'termostato', 'ventilador'],
                    'nivel bajo de refrigerante': ['fugas', 'nivel', 'calidad'],
                    'problema de termostato': ['fallo', 'regulaci√≥n', 'temperatura'],
                    'ventilador no funciona': ['funcionamiento', 'motor', 'cables'],
                    'problema de radiador': ['obstrucci√≥n', 'fuga', 'da√±o'],
                    'fuga de refrigerante': ['mangueras', 'conectores', 'radiador']
                }
            },
            direcci√≥n: {
                problems: {
                    'direcci√≥n dura': ['l√≠quido', 'bomba', 'componentes'],
                    'necesita alineaci√≥n': ['alineaci√≥n', 'ruedas delanteras'],
                    'necesita balanceo': ['balanceo', 'ruedas'],
                    'volante vibra': ['balanceo', 'neum√°ticos', 'alineaci√≥n'],
                    'problema de direcci√≥n': ['l√≠quido', 'bomba', 'componentes'],
                    'desalineado': ['alineaci√≥n', 'suspensi√≥n', 'neum√°ticos']
                }
            },
            neum√°ticos: {
                problems: {
                    'presi√≥n baja': ['presi√≥n', 'aire', 'inflado'],
                    'desgaste irregular': ['alineaci√≥n', 'balanceo', 'suspensi√≥n'],
                    'neum√°ticos lisos': ['desgaste', 'reemplazo'],
                    'vibraci√≥n en ruedas': ['balanceo', 'alineaci√≥n', 'neum√°ticos'],
                    'da√±o en neum√°ticos': ['cortes', 'bultos', 'desgaste'],
                    'ruido de neum√°ticos': ['desgaste', 'presi√≥n', 'alineaci√≥n']
                }
            }
        };

        // Navegaci√≥n entre pesta√±as
        function switchTab(tab) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar contenido seleccionado
            document.getElementById(tab + '-content').classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');

            // Resetear formulario si cambiamos a chat
            if (tab === 'chat') {
                resetForm();
            }
        }

        // Seleccionar categor√≠a
        function selectCategory(category) {
            selectedCategory = category;
            currentStep = 2;

            // Actualizar historial
            updateHistory();

            // Mostrar problemas de la categor√≠a
            const problems = Object.keys(formData[category].problems);
            const problemButtons = document.getElementById('problem-buttons');
            problemButtons.innerHTML = '';

            problems.forEach(problem => {
                const btn = document.createElement('button');
                btn.className = 'problem-btn';
                btn.onclick = () => selectProblem(problem);
                btn.innerHTML = `
                    <span class="btn-text">${problem}</span>
                `;
                problemButtons.appendChild(btn);
            });

            // Cambiar a paso 2
            showStep(2);
        }

        // Seleccionar problema
        function selectProblem(problem) {
            selectedProblem = problem;
            currentStep = 3;

            // Actualizar historial
            updateHistory();

            // Mostrar s√≠ntomas adicionales
            const symptoms = formData[selectedCategory].problems[problem];
            const symptomsButtons = document.getElementById('symptoms-buttons');
            symptomsButtons.innerHTML = '';

            symptoms.forEach(symptom => {
                const btn = document.createElement('button');
                btn.className = 'symptom-btn';
                btn.onclick = () => toggleSymptom(symptom, btn);
                btn.innerHTML = `
                    <span class="btn-text">${symptom}</span>
                `;
                symptomsButtons.appendChild(btn);
            });

            // Cambiar a paso 3
            showStep(3);
        }

        // Alternar s√≠ntoma
        function toggleSymptom(symptom, button) {
            if (selectedSymptoms.includes(symptom)) {
                selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
                button.classList.remove('selected');
            } else {
                selectedSymptoms.push(symptom);
                button.classList.add('selected');
            }

            // Actualizar historial
            updateHistory();
        }

        // Actualizar historial visual
        function updateHistory() {
            const historyContainer = document.getElementById('history-items');
            let historyHtml = '';

            if (selectedCategory) {
                historyHtml += `<div class="history-item">
                    <span class="history-icon">üîß</span>
                    <span class="history-label">Sistema:</span>
                    <span class="history-value">${getCategoryDisplayName(selectedCategory)}</span>
                </div>`;
            }

            if (selectedProblem) {
                historyHtml += `<div class="history-item">
                    <span class="history-icon">‚ö†Ô∏è</span>
                    <span class="history-label">Problema:</span>
                    <span class="history-value">${selectedProblem}</span>
                </div>`;
            }

            if (selectedSymptoms.length > 0) {
                historyHtml += `<div class="history-item">
                    <span class="history-icon">üîç</span>
                    <span class="history-label">S√≠ntomas:</span>
                    <span class="history-value">${selectedSymptoms.join(', ')}</span>
                </div>`;
            }

            if (historyHtml === '') {
                historyHtml = '<span class="history-placeholder">Ninguna selecci√≥n realizada</span>';
            }

            historyContainer.innerHTML = historyHtml;
        }

        // Obtener nombre de visualizaci√≥n de categor√≠a
        function getCategoryDisplayName(category) {
            const displayNames = {
                'motor': 'Motor',
                'frenos': 'Frenos',
                'transmisi√≥n': 'Transmisi√≥n',
                'suspensi√≥n': 'Suspensi√≥n',
                'el√©ctrico': 'Sistema El√©ctrico',
                'combustible': 'Combustible',
                'refrigeraci√≥n': 'Refrigeraci√≥n',
                'direcci√≥n': 'Direcci√≥n',
                'neum√°ticos': 'Neum√°ticos'
            };
            return displayNames[category] || category;
        }

        // Mostrar paso espec√≠fico
        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-' + step).classList.add('active');
            currentStep = step;
        }

        // Volver atr√°s
        function goBack() {
            if (currentStep === 3) {
                showStep(2);
                selectedSymptoms = [];
            } else if (currentStep === 2) {
                showStep(1);
                selectedProblem = '';
            }
        }

        // Resetear formulario
        function resetForm() {
            currentStep = 1;
            selectedCategory = '';
            selectedProblem = '';
            selectedSymptoms = [];
            showStep(1);
            updateHistory(); // Limpiar historial
        }

        // Diagnosticar desde formulario
        function diagnoseFromForm() {
            if (!selectedCategory || !selectedProblem) {
                showNotification('Por favor completa todos los pasos', 'error');
                return;
            }

            // Construir descripci√≥n basada en selecciones
            let description = `Problema en ${selectedCategory}: ${selectedProblem}`;
            if (selectedSymptoms.length > 0) {
                description += `. S√≠ntomas adicionales: ${selectedSymptoms.join(', ')}`;
            }

            // Usar el motor de inferencia existente
            diagnoseWithText(description);
        }

        // Funci√≥n original de diagn√≥stico (renombrada)
        async function diagnoseWithText(inputText) {
            try {
                const response = await fetch('/diagnose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: inputText })
                });
                const data = await response.json();
                lastDiagnosis = data;

                let resultHtml = '<h2>Resultado del Diagn√≥stico</h2>';

                // Mostrar puntuaci√≥n
                resultHtml += `<p class="score">Nivel de Confianza: ${data.puntuaci√≥n}</p>`;

                // Mostrar categor√≠as detectadas
                if (data.categor√≠as && data.categor√≠as.length > 0) {
                    resultHtml += '<div class="categories"><strong>√Åreas afectadas:</strong> ';
                    data.categor√≠as.forEach(cat => {
                        resultHtml += `<span>${cat}</span>`;
                    });
                    resultHtml += '</div>';
                }

                // Mostrar recomendaci√≥n general
                if (data.recomendaci√≥n_general) {
                    resultHtml += `<div class="recommendation">${data.recomendaci√≥n_general}</div>`;
                }

                // Mostrar diagn√≥sticos espec√≠ficos
                if (Array.isArray(data.diagn√≥stico)) {
                    resultHtml += '<h3>Diagn√≥sticos Espec√≠ficos:</h3><ul class="diagnosis-list">';
                    data.diagn√≥stico.forEach(d => {
                        resultHtml += `<li>${d}</li>`;
                    });
                    resultHtml += '</ul>';
                } else {
                    resultHtml += `<p>${data.diagn√≥stico}</p>`;
                }

                document.getElementById('result').innerHTML = resultHtml;

                // Reactivar y mostrar los botones de feedback
                const feedbackSection = document.getElementById('feedback');
                feedbackSection.style.display = 'block';

                // Rehabilitar los botones
                const feedbackButtons = feedbackSection.querySelectorAll('button');
                feedbackButtons.forEach(button => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                });
            } catch (error) {
                console.error('Error al realizar el diagn√≥stico:', error);
                showNotification('Error al procesar el diagn√≥stico', 'error');
            }
        }

        // Funci√≥n de diagn√≥stico original (para chat)
        async function diagnose() {
            const input = document.getElementById('input').value;
            if (!input.trim()) {
                showNotification('Por favor, describe el problema del veh√≠culo', 'error');
                return;
            }
            await diagnoseWithText(input);
        }

        async function giveFeedback(wasHelpful) {
            if (!lastDiagnosis) return;

            // Deshabilitar ambos botones para evitar m√∫ltiples env√≠os
            const feedbackButtons = document.querySelectorAll('#feedback button');
            feedbackButtons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });

            try {
                await fetch('/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        diagnosis: lastDiagnosis,
                        wasHelpful: wasHelpful
                    })
                });
                showNotification('¬°Gracias por tu retroalimentaci√≥n!', 'success');

                // Ocultar completamente la secci√≥n de feedback despu√©s de enviar
                document.getElementById('feedback').style.display = 'none';
            } catch (error) {
                console.error('Error al enviar retroalimentaci√≥n:', error);
                showNotification('Error al enviar la retroalimentaci√≥n', 'error');

                // Rehabilitar botones en caso de error
                feedbackButtons.forEach(button => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                });
            }
        }

        // Sistema de notificaciones
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            notification.innerHTML = `
                <div class="notification-content">${message}</div>
            `;

            container.appendChild(notification);

            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                if (notification.parentNode === container) {
                    notification.classList.add('hide');
                    setTimeout(() => {
                        if (notification.parentNode === container) {
                            container.removeChild(notification);
                        }
                    }, 500);
                }
            }, 5000);
        }
    </script>
</body>

</html>